name: Build, Sign & Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  actions: read
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      artifact-id: ${{ steps.upload-exe.outputs.artifact-id }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - run: npm ci
      - run: npm run build
      - run: npm run package

      - name: Upload Windows EXE (for signing)
        id: upload-exe
        uses: actions/upload-artifact@v4
        with:
          name: mcp-ssh-win-unsigned
          path: dist/mcp-ssh-win.exe

      - name: Upload Linux binary
        uses: actions/upload-artifact@v4
        with:
          name: mcp-ssh-linux
          path: dist/mcp-ssh-linux

  sign:
    needs: build
    if: vars.SIGNPATH_ORGANIZATION_ID != ''
    runs-on: ubuntu-latest
    steps:
      - name: Sign Windows EXE with SignPath
        uses: signpath/github-action-submit-signing-request@v1
        with:
          api-token: "${{ secrets.SIGNPATH_API_TOKEN }}"
          organization-id: "${{ vars.SIGNPATH_ORGANIZATION_ID }}"
          project-slug: "mcp-ssh-server"
          signing-policy-slug: "release-signing"
          artifact-configuration-slug: "exe"
          github-artifact-id: "${{ needs.build.outputs.artifact-id }}"
          wait-for-completion: true
          output-artifact-directory: "signed"

      - name: Upload signed EXE
        uses: actions/upload-artifact@v4
        with:
          name: mcp-ssh-win-signed
          path: signed/mcp-ssh-win.exe

  release:
    needs: [build, sign]
    if: always() && needs.build.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # Use signed EXE if signing succeeded, otherwise fall back to unsigned
      - name: Download signed Windows EXE
        if: needs.sign.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: mcp-ssh-win-signed
          path: dist

      - name: Download unsigned Windows EXE (fallback)
        if: needs.sign.result != 'success'
        uses: actions/download-artifact@v4
        with:
          name: mcp-ssh-win-unsigned
          path: dist

      - name: Download Linux binary
        uses: actions/download-artifact@v4
        with:
          name: mcp-ssh-linux
          path: dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/mcp-ssh-win.exe
            dist/mcp-ssh-linux
          generate_release_notes: true
          body: |
            ## MCP SSH Manager ${{ github.ref_name }}

            | File | Platform |
            |------|----------|
            | `mcp-ssh-win.exe` | Windows x64 |
            | `mcp-ssh-linux` | Linux x64 |

            Node.js is bundled inside. No dependencies needed.
